---

- name: Setup raspberry pi
  hosts: pi
  tasks:
    - name: Wait 150 seconds for raspberry pi to boot, but only start checking after 10 seconds
      wait_for_connection:
        delay: 10
        timeout: 150

    - name: Install mosquitto and lsof
      apt:
        name:
          - mosquitto
          - lsof
        update_cache: yes
        autoclean: yes
        state: present
      become: True

    - name: Kill previous process running on port 8000, if exists
      become: yes
      shell: "pkill -9 $(lsof -t -i:8000)"
      ignore_errors: yes

    - name: Update mosquitto configuration file to listen on port 8000
      become: yes
      blockinfile:
        path: /etc/mosquitto/mosquitto.conf
        block: |
          listener 8000

    - name: Restart mosquitto service
      become: yes
      shell: "/etc/init.d/mosquitto restart"
